version: "3.8"

services:
  # Node.js Frontend (React + Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ${FRONTEND_CONTAINER_NAME:-liferay-frontend}
    ports:
      - "${FRONTEND_HOST_PORT:-3000}:3000"
    environment:
      - VITE_API_BASE_URL=
      - VITE_LIFERAY_SITE_ID=33815
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    depends_on:
      liferay:
        condition: service_healthy
    restart: unless-stopped
    command: ["npm", "run", "dev", "--", "--host", "0.0.0.0", "--port", "3000"]
    networks:
      - liferay-network

  # Gradle Builder for Liferay Modules
  gradle-builder:
    image: gradle:8.5-jdk17
    container_name: ${GRADLE_CONTAINER_NAME:-liferay-gradle-builder}
    working_dir: /workspace
    volumes:
      - ./backend:/workspace
      - gradle-cache:/root/.gradle
      - maven-cache:/root/.m2
    command: tail -f /dev/null
    environment:
      GRADLE_OPTS: "-Xmx2g -Xms1g"
    networks:
      - liferay-network
    restart: unless-stopped

  # Liferay Portal Backend CE
  liferay:
    image: liferay/portal:${LIFERAY_VERSION:-7.4.3.132-ga132}
    container_name: ${LIFERAY_CONTAINER_NAME:-liferay-portal-ce}
    ports:
      - "${LIFERAY_HOST_PORT:-8080}:8080"
    environment:
      LIFERAY_SETUP_PERIOD_WIZARD_PERIOD_ENABLED: "true"
      LIFERAY_JVM_OPTS: ${LIFERAY_JVM_OPTS:-"-Xmx1g -Xms512m"}

      # Disable Hostname Validation Filter
      LIFERAY_COM_LIFERAY_PORTAL_SERVLET_FILTERS_VALIDHOSTNAME_VALIDHOSTNAMEFILTER_ENABLED: "false"

      # Host validation
      LIFERAY_VIRTUAL_PERIOD_HOSTS_PERIOD_ALLOWED: "localhost,127.0.0.1,liferay-portal-ce"
      LIFERAY_VIRTUAL_PERIOD_HOSTS_PERIOD_VALID_PERIOD_HOSTS: "*"
      LIFERAY_WEB_PERIOD_SERVER_PERIOD_HOSTS: "liferay-portal-ce"

      # Default company host
      LIFERAY_COMPANY_PERIOD_DEFAULT_PERIOD_VIRTUAL_PERIOD_HOST: "localhost"

    volumes:
      - liferay-data:/opt/liferay/data
      - liferay-osgi-configs:/opt/liferay/osgi/configs
      - liferay-osgi-marketplace:/opt/liferay/osgi/marketplace
      - liferay-osgi-modules:/opt/liferay/osgi/modules
      - liferay-osgi-war:/opt/liferay/osgi/war

      # Hot Deploy
      - ./backend/deploy:/mnt/liferay/deploy
      - ./backend/modules:/workspace/modules
      - ./backend/themes:/workspace/themes

      # Configs
      - ./files:/mnt/liferay/files
      - ./backend/gradle.properties:/workspace/gradle.properties
      - ./backend/build.gradle:/workspace/build.gradle
      - ./backend/configs/docker/portal-ext.properties:/opt/liferay/portal-ext.properties

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

    networks:
      - liferay-network

volumes:
  liferay-data:
  liferay-osgi-configs:
  liferay-osgi-marketplace:
  liferay-osgi-modules:
  liferay-osgi-war:
  gradle-cache:
  maven-cache:

networks:
  liferay-network:
    driver: bridge
