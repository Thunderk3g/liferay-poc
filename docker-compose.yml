services:
  # Node.js Frontend (React + Vite)
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: ${FRONTEND_CONTAINER_NAME:-liferay-frontend}
    ports:
      - "${FRONTEND_HOST_PORT:-3000}:5173"
    environment:
      - VITE_API_BASE_URL=http://liferay:8080
      - VITE_LIFERAY_SITE_ID=20124
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
    depends_on:
      liferay:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - liferay-network

  # Gradle Builder for Liferay Modules
  gradle-builder:
    image: gradle:8.5-jdk17
    container_name: ${GRADLE_CONTAINER_NAME:-liferay-gradle-builder}
    working_dir: /workspace
    volumes:
      - ./backend:/workspace
      - gradle-cache:/root/.gradle
      - maven-cache:/root/.m2
    command: tail -f /dev/null
    environment:
      GRADLE_OPTS: "-Xmx2g -Xms1g"
    networks:
      - liferay-network
    restart: unless-stopped

  # Liferay Portal Backend
  liferay:
    image: liferay/portal:${LIFERAY_VERSION:-7.4.3.132-ga132}
    container_name: ${LIFERAY_CONTAINER_NAME:-liferay-portal-ce}
    ports:
      - "${LIFERAY_HOST_PORT:-8080}:8080"
    environment:
      # Skip Setup Wizard
      LIFERAY_SETUP_PERIOD_WIZARD_PERIOD_ENABLED: "false"

      # JVM Options
      LIFERAY_JVM_OPTS: ${LIFERAY_JVM_OPTS:-"-Xmx1g -Xms512m"}

      # Use embedded HSQL database (default behavior)
      # No external database configuration needed

      # Proxy Configuration (uncomment if needed for corporate networks)
      # HTTP_PROXY: ${HTTP_PROXY}
      # HTTPS_PROXY: ${HTTPS_PROXY}
      # NO_PROXY: ${NO_PROXY}

    volumes:
      # Persist Liferay data (includes embedded HSQL database)
      - liferay-data:/opt/liferay/data

      # Persist OSGi configurations
      - liferay-osgi-configs:/opt/liferay/osgi/configs

      # Persist OSGi marketplace
      - liferay-osgi-marketplace:/opt/liferay/osgi/marketplace

      # Persist OSGi modules
      - liferay-osgi-modules:/opt/liferay/osgi/modules

      # Persist OSGi WAR files
      - liferay-osgi-war:/opt/liferay/osgi/war

      # Hot-deploy folder for built modules
      - ./backend/deploy:/mnt/liferay/deploy

      # Mount modules directory for hot deployment
      - ./backend/modules:/workspace/modules

      # Mount themes directory for hot deployment
      - ./backend/themes:/workspace/themes

      # Optional: Mount for configuration files
      - ./files:/mnt/liferay/files

      # Mount build configuration for Liferay deployments
      - ./backend/gradle.properties:/workspace/gradle.properties
      - ./backend/build.gradle:/workspace/build.gradle

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 300s

    networks:
      - liferay-network

volumes:
  liferay-data:
    driver: local
  liferay-osgi-configs:
    driver: local
  liferay-osgi-marketplace:
    driver: local
  liferay-osgi-modules:
    driver: local
  liferay-osgi-war:
    driver: local
  gradle-cache:
    driver: local
  maven-cache:
    driver: local

networks:
  liferay-network:
    driver: bridge
